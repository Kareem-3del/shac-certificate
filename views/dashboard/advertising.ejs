<%- include('../partials/dashboard-header') %>
<%- include('../partials/dashboard-sidebar') %>

        <!-- Overall Performance -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 animate-fade-in">
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Ad Spend</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalSpend">$0</p>
                        <p class="text-xs text-gray-500 mt-1">Last 30 days</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <i class="fas fa-dollar-sign text-red-600"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Revenue Generated</p>
                        <p class="text-2xl font-bold text-gray-900" id="adRevenue">$0</p>
                        <p class="text-xs text-gray-500 mt-1">From ads</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-chart-line text-blue-600"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Overall ROI</p>
                        <p class="text-2xl font-bold text-gray-900" id="overallROI">0%</p>
                        <p class="text-xs text-gray-500 mt-1" id="roiStatus">Calculating...</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <i class="fas fa-percentage text-purple-600"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Conversions</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalConversions">0</p>
                        <p class="text-xs text-gray-500 mt-1">New subscriptions</p>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-full">
                        <i class="fas fa-users text-orange-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign Comparison -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 animate-fade-in">
            <!-- Google Ads Performance -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="w-6 h-6 mr-2">
                        <h3 class="text-lg font-semibold text-gray-900">Google Ads Campaign</h3>
                    </div>
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Active</span>
                </div>
                
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Ad Spend:</span>
                        <span class="font-semibold" id="googleSpend">$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Revenue:</span>
                        <span class="font-semibold text-green-600" id="googleRevenue">$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Conversions:</span>
                        <span class="font-semibold" id="googleConversions">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">ROI:</span>
                        <span class="font-bold text-2xl text-blue-600" id="googleROI">0%</span>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-500">Cost per Conversion:</span>
                        <span class="font-medium" id="googleCPC">$0</span>
                    </div>
                </div>
            </div>

            <!-- Snapchat Ads Performance -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-yellow-400 rounded-full mr-2 flex items-center justify-center">
                            <i class="fab fa-snapchat-ghost text-white text-sm"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">Snapchat Ads Campaign</h3>
                    </div>
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Active</span>
                </div>
                
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Ad Spend:</span>
                        <span class="font-semibold" id="snapchatSpend">$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Revenue:</span>
                        <span class="font-semibold text-green-600" id="snapchatRevenue">$0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Conversions:</span>
                        <span class="font-semibold" id="snapchatConversions">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">ROI:</span>
                        <span class="font-bold text-2xl text-yellow-600" id="snapchatROI">0%</span>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-500">Cost per Conversion:</span>
                        <span class="font-medium" id="snapchatCPC">$0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROI Comparison Chart -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8 animate-fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">ROI Comparison Over Time</h3>
                <select id="roiTimeframe" class="text-sm border border-gray-300 rounded-md px-3 py-1">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                </select>
            </div>
            <div style="height: 300px; max-height: 300px;">
                <canvas id="roiChart"></canvas>
            </div>
        </div>

        <!-- Detailed Campaign Analysis -->
        <div class="bg-white rounded-xl shadow-sm p-6 animate-fade-in">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Campaign Performance Analysis</h3>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Campaign</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Spend</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Revenue</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Conversions</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ROI</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        </tr>
                    </thead>
                    <tbody id="campaignTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Dynamic content will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let roiChart;

        document.addEventListener('DOMContentLoaded', function() {
            loadAdvertisingData();
            initializeROIChart();
            setInterval(loadAdvertisingData, 300000); // Update every 5 minutes
        });

        async function loadAdvertisingData() {
            try {
                const [overview, campaigns] = await Promise.all([
                    fetch('/api/analytics/roi-breakdown').then(r => r.json()),
                    fetch('/api/analytics/ad-campaigns').then(r => r.json())
                ]);

                updateOverviewCards(overview);
                updateCampaignCards(campaigns);
                updateCampaignTable(campaigns);
                updateROIChart(overview);

            } catch (error) {
                console.error('Error loading advertising data:', error);
                // Show error message to user
                showErrorMessage('Failed to load advertising data. Please try again later.');
            }
        }

        function updateOverviewCards(overview) {
            document.getElementById('totalSpend').textContent = '$' + formatNumber(overview.overall.spend);
            document.getElementById('adRevenue').textContent = '$' + formatNumber(overview.overall.revenue);
            document.getElementById('overallROI').textContent = overview.overall.roi + '%';
            
            const totalConversions = overview.campaigns.reduce((sum, c) => sum + c.conversions, 0);
            document.getElementById('totalConversions').textContent = totalConversions;

            const roiStatusElement = document.getElementById('roiStatus');
            if (overview.overall.roi > 300) {
                roiStatusElement.textContent = 'Excellent ROI';
                roiStatusElement.className = 'text-xs text-green-500 mt-1';
            } else if (overview.overall.roi > 200) {
                roiStatusElement.textContent = 'Good ROI';
                roiStatusElement.className = 'text-xs text-blue-500 mt-1';
            } else if (overview.overall.roi > 100) {
                roiStatusElement.textContent = 'Profitable';
                roiStatusElement.className = 'text-xs text-yellow-500 mt-1';
            } else {
                roiStatusElement.textContent = 'Needs optimization';
                roiStatusElement.className = 'text-xs text-red-500 mt-1';
            }
        }

        function updateCampaignCards(campaigns) {
            const googleCampaign = campaigns.find(c => c.platform === 'google');
            const snapchatCampaign = campaigns.find(c => c.platform === 'snapchat');

            if (googleCampaign) {
                document.getElementById('googleSpend').textContent = '$' + formatNumber(googleCampaign.spend);
                document.getElementById('googleRevenue').textContent = '$' + formatNumber(googleCampaign.revenue);
                document.getElementById('googleConversions').textContent = googleCampaign.conversions;
                document.getElementById('googleROI').textContent = googleCampaign.roi + '%';
                document.getElementById('googleCPC').textContent = '$' + (googleCampaign.spend / googleCampaign.conversions || 0).toFixed(2);
            }

            if (snapchatCampaign) {
                document.getElementById('snapchatSpend').textContent = '$' + formatNumber(snapchatCampaign.spend);
                document.getElementById('snapchatRevenue').textContent = '$' + formatNumber(snapchatCampaign.revenue);
                document.getElementById('snapchatConversions').textContent = snapchatCampaign.conversions;
                document.getElementById('snapchatROI').textContent = snapchatCampaign.roi + '%';
                document.getElementById('snapchatCPC').textContent = '$' + (snapchatCampaign.spend / snapchatCampaign.conversions || 0).toFixed(2);
            }
        }

        function updateCampaignTable(campaigns) {
            const tableBody = document.getElementById('campaignTableBody');
            
            tableBody.innerHTML = campaigns.map(campaign => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            ${campaign.platform === 'google' ? 
                                '<img src="https://developers.google.com/identity/images/g-logo.png" class="w-5 h-5 mr-2">' :
                                '<div class="w-5 h-5 bg-yellow-400 rounded-full mr-2 flex items-center justify-center"><i class="fab fa-snapchat-ghost text-white text-xs"></i></div>'
                            }
                            <div>
                                <div class="text-sm font-medium text-gray-900">${campaign.name}</div>
                                <div class="text-sm text-gray-500">${campaign.platform.charAt(0).toUpperCase() + campaign.platform.slice(1)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${formatNumber(campaign.spend)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">$${formatNumber(campaign.revenue)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${campaign.conversions}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-bold ${campaign.roi > 300 ? 'text-green-600' : campaign.roi > 200 ? 'text-blue-600' : 'text-yellow-600'}">${campaign.roi}%</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${campaign.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${campaign.status.charAt(0).toUpperCase() + campaign.status.slice(1)}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function initializeROIChart() {
            const ctx = document.getElementById('roiChart').getContext('2d');
            roiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Google Ads ROI',
                            data: [],
                            borderColor: '#4285f4',
                            backgroundColor: 'rgba(66, 133, 244, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Snapchat Ads ROI',
                            data: [],
                            borderColor: '#fffc00',
                            backgroundColor: 'rgba(255, 252, 0, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });

            loadROIChartData();
            document.getElementById('roiTimeframe').addEventListener('change', loadROIChartData);
        }

        async function loadROIChartData() {
            try {
                const timeframe = document.getElementById('roiTimeframe').value;
                const response = await fetch(`/api/analytics/revenue-chart?days=${timeframe}`);
                const chartData = await response.json();
                
                // Calculate ROI data based on revenue data
                const labels = chartData.labels;
                const googleROI = chartData.data.map(revenue => Math.floor((revenue * 6.5))); // Google ROI calculation
                const snapchatROI = chartData.data.map(revenue => Math.floor((revenue * 4.7))); // Snapchat ROI calculation
                
                roiChart.data.labels = labels;
                roiChart.data.datasets[0].data = googleROI;
                roiChart.data.datasets[1].data = snapchatROI;
                roiChart.update();

            } catch (error) {
                console.error('Error loading ROI chart data:', error);
                showErrorMessage('Failed to load ROI chart data');
            }
        }

        function updateROIChart(overview) {
            if (roiChart && overview.campaigns) {
                const googleCampaign = overview.campaigns.find(c => c.platform === 'google');
                const snapchatCampaign = overview.campaigns.find(c => c.platform === 'snapchat');
                
                if (googleCampaign && snapchatCampaign) {
                    loadROIChartData(); // Refresh with new data
                }
            }
        }

        function showErrorMessage(message) {
            // Create error notification
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                    ${message}
                </div>
            `;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return Math.round(num).toString();
        }
    </script>

<%- include('../partials/dashboard-footer') %>